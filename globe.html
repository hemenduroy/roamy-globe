<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roamy Stupid — Globe</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, sans-serif; background: #1a1a1a; color: #e0e0e0; }
    .layout { display: flex; height: 100vh; }
    .panel-left { width: 560px; min-width: 480px; padding: 12px; overflow-y: auto; border-right: 1px solid #333; background: #1a1a1a; flex-shrink: 0; }
    .panel-left h2 { font-size: 1rem; margin: 0 0 12px 0; color: #f0c050; }
    .grid { display: grid; grid-template-columns: 28px 28px 1fr 1fr 1fr 28px; gap: 8px 14px; align-items: center; }
    .grid .header { font-size: 11px; color: #888; }
    .grid .header.header-num { text-align: right; font-variant-numeric: tabular-nums; }
    .grid .row-num { font-size: 11px; color: #aaa; text-align: right; font-variant-numeric: tabular-nums; }
    .grid .header .col-num { display: inline-block; width: 16px; height: 16px; line-height: 16px; text-align: center; border-radius: 50%; background: #333; color: #f0c050; font-weight: 700; font-size: 10px; margin-right: 4px; }
    .grid .row-swatch { width: 14px; height: 14px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); flex-shrink: 0; }
    .grid .row-clear { width: 24px; height: 24px; padding: 0; border: 1px solid #555; border-radius: 4px; background: #333; color: #888; font-size: 14px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .grid .row-clear:hover { background: #444; color: #f0c050; border-color: #666; }
    .grid select { padding: 6px 8px; background: #252525; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-size: 12px; min-width: 0; }
    .grid select option { background: #252525; }
    .panel-right { flex: 1; position: relative; min-width: 0; }
    .panel-right { position: relative; }
    #globeContainer { width: 100%; height: 100%; background: #0a0a12; }
    .globe-toolbar { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; align-items: center; gap: 8px; }
    .globe-toolbar label { font-size: 12px; color: #e0e0e0; cursor: pointer; user-select: none; }
    .globe-toolbar input[type="checkbox"] { cursor: pointer; }
    .toolbar { margin-bottom: 10px; }
    .toolbar button { padding: 6px 12px; background: #333; color: #e0e0e0; border: 1px solid #444; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .toolbar button:hover { background: #444; color: #f0c050; }
    .toolbar .hint { font-size: 11px; color: #666; margin-top: 4px; }
    .site-title { padding: 10px 12px; border-bottom: 1px solid #333; background: #1a1a1a; }
    .site-title a { color: #f0c050; text-decoration: none; font-weight: bold; font-size: 1rem; }
    .site-title a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <p class="site-title"><a href="index.html">ROAMY STUPID</a></p>
  <div class="layout">
    <div class="panel-left">
      <h2>41 × 3 triplets (stage1 | roamy | stage1)</h2>
      <div class="grid" id="tripletGrid"></div>
    </div>
    <div class="panel-right">
      <div class="globe-toolbar">
        <input type="checkbox" id="connect13Long" checked />
        <label for="connect13Long">Complete loop</label>
      </div>
      <div id="globeContainer"></div>
    </div>
  </div>

  <script type="importmap">
  {"imports":{"three":"https://unpkg.com/three@0.160.0/build/three.module.js","three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"}}
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { Line2 } from 'three/addons/lines/Line2.js';
    import { LineGeometry } from 'three/addons/lines/LineGeometry.js';
    import { LineMaterial } from 'three/addons/lines/LineMaterial.js';

    const DATA = window.ROUTE_DATA;
    const ROWS = 41;
    const COLORS = ["#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6","#bcf60c","#fabebe","#008080","#e6beff","#9a6324","#fffac8","#800000","#aaffc3","#808000","#ffd8b1","#000075","#808080","#e63946","#2a9d8f","#e9c46a","#1d3557","#457b9d","#a8dadc","#f4a261","#e76f51","#2ec4b6","#ff9f1c","#011627","#fdfffc","#41ead4","#ff006e","#8338ec","#3a86ff","#fb5607","#06d6a0","#118ab2","#ef476f","#ffd166","#073b4c"];

    function latLonToVector3(lat, lon) {
      const phi = (90 - lat) * Math.PI / 180;
      const th = lon * Math.PI / 180;
      return new THREE.Vector3(
        Math.sin(phi) * Math.cos(th),
        Math.cos(phi),
        -Math.sin(phi) * Math.sin(th)
      );
    }

    function slerpSegment(v1, v2, numPoints) {
      const pts = [];
      for (let i = 0; i <= numPoints; i++) {
        const t = i / numPoints;
        const angle = Math.acos(Math.max(-1, Math.min(1, v1.dot(v2))));
        if (angle < 1e-6) {
          pts.push(v1.clone());
          continue;
        }
        const a = Math.sin((1 - t) * angle) / Math.sin(angle);
        const b = Math.sin(t * angle) / Math.sin(angle);
        pts.push(new THREE.Vector3().addVectors(v1.clone().multiplyScalar(a), v2.clone().multiplyScalar(b)).normalize());
      }
      return pts;
    }

    function routePoints(lat1, lon1, lat2, lon2, lat3, lon3, numPerSegment) {
      const v1 = latLonToVector3(lat1, lon1);
      const v2 = latLonToVector3(lat2, lon2);
      const v3 = latLonToVector3(lat3, lon3);
      const seg1 = slerpSegment(v1, v2, numPerSegment);
      const seg2 = slerpSegment(v2, v3, numPerSegment);
      return seg1.slice(0, -1).concat(seg2);
    }

    function slerpLongArc(v1, v2, numPoints) {
      const pts = [];
      const angleShort = Math.acos(Math.max(-1, Math.min(1, v1.dot(v2))));
      const angleLong = 2 * Math.PI - angleShort;
      if (angleLong < 1e-6) return [v1.clone(), v2.clone()];
      for (let i = 0; i <= numPoints; i++) {
        const t = i / numPoints;
        const a = Math.sin((1 - t) * angleLong) / Math.sin(angleLong);
        const b = Math.sin(t * angleLong) / Math.sin(angleLong);
        pts.push(new THREE.Vector3().addVectors(v1.clone().multiplyScalar(a), v2.clone().multiplyScalar(b)).normalize());
      }
      return pts;
    }

    let scene, camera, renderer, controls, routeLines = [], routeWrapLines = [], routeDots = [], routeLabelSprites = [];
    const DOT_RADIUS = 0.018;
    const LABEL_SIZE = 0.06;

    function makeLabelTexture(num) {
      const c = document.createElement("canvas");
      c.width = 32;
      c.height = 32;
      const ctx = c.getContext("2d");
      ctx.fillStyle = "#1a1a1a";
      ctx.beginPath();
      ctx.arc(16, 16, 15, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = "#f0c050";
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.fillStyle = "#f0c050";
      ctx.font = "bold 20px system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(String(num), 16, 16);
      const tex = new THREE.CanvasTexture(c);
      tex.needsUpdate = true;
      return tex;
    }

    function addLabelSprite(num, worldPos) {
      const tex = num === 1 ? (window._labelTex1 || (window._labelTex1 = makeLabelTexture(1)))
        : num === 2 ? (window._labelTex2 || (window._labelTex2 = makeLabelTexture(2)))
        : (window._labelTex3 || (window._labelTex3 = makeLabelTexture(3)));
      const mat = new THREE.SpriteMaterial({ map: tex, color: 0xffffff });
      const sprite = new THREE.Sprite(mat);
      sprite.position.copy(worldPos).multiplyScalar(1.02);
      sprite.scale.set(LABEL_SIZE, LABEL_SIZE, 1);
      return sprite;
    }

    function initGlobe() {
      const container = document.getElementById("globeContainer");
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.z = 2.5;
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(renderer.domElement);
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      const globeGeo = new THREE.SphereGeometry(1, 64, 48);
      const placeholderMat = new THREE.MeshPhongMaterial({ color: 0x1a2332, emissive: 0x0a0f14, specular: 0x222, shininess: 8 });
      let globeMesh = new THREE.Mesh(globeGeo, placeholderMat);
      scene.add(globeMesh);
      const loader = new THREE.TextureLoader();
      loader.load("earth_texture.jpg", (tex) => {
        tex.colorSpace = THREE.SRGBColorSpace;
        scene.remove(globeMesh);
        globeMesh.material.dispose();
        const globeMat = new THREE.MeshPhongMaterial({
          map: tex,
          color: 0xffffff,
          specular: 0x333333,
          shininess: 12,
          emissive: 0x222244
        });
        globeMesh = new THREE.Mesh(globeGeo, globeMat);
        scene.add(globeMesh);
      }, undefined, () => {});
      const light = new THREE.DirectionalLight(0xffffff, 1.2);
      light.position.set(2, 2, 2);
      scene.add(light);
      const fillLight = new THREE.DirectionalLight(0xffffff, 0.4);
      fillLight.position.set(-1.5, -1, 1);
      scene.add(fillLight);
      scene.add(new THREE.AmbientLight(0xcccccc, 0.85));

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
      window.addEventListener("resize", () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
      });
    }

    function updateRoutes() {
      if (!scene) return;
      routeLines.forEach(line => { if (line.parent) line.parent.remove(line); line.geometry.dispose(); line.material.dispose(); });
      routeLines = [];
      routeWrapLines.forEach(line => { if (line.parent) line.parent.remove(line); line.geometry.dispose(); line.material.dispose(); });
      routeWrapLines = [];
      routeDots.forEach(mesh => { if (mesh.parent) mesh.parent.remove(mesh); mesh.geometry.dispose(); mesh.material.dispose(); });
      routeDots = [];
      routeLabelSprites.forEach(s => { if (s.parent) s.parent.remove(s); s.material.dispose(); });
      routeLabelSprites = [];
      const locCoords = DATA.locs;
      const roamyCoords = DATA.roamy;
      const resolution = new THREE.Vector2();
      renderer.getSize(resolution);
      const lineWidth = 2.5;

      for (let r = 0; r < ROWS; r++) {
        const selLoc1 = document.getElementById("loc1_" + r);
        const selRoamy = document.getElementById("roamy_" + r);
        const selLoc2 = document.getElementById("loc2_" + r);
        const v1 = selLoc1 && selLoc1.value;
        const vMid = selRoamy && selRoamy.value;
        const v2 = selLoc2 && selLoc2.value;
        if (v1 === "" || vMid === "" || v2 === "") continue;
        const p1 = locCoords[parseInt(v1, 10)];
        const pMid = roamyCoords[parseInt(vMid, 10)];
        const p2 = locCoords[parseInt(v2, 10)];
        if (!p1 || !pMid || !p2) continue;
        const col = new THREE.Color(COLORS[r % COLORS.length]);
        const pts = routePoints(p1.lat, p1.lon, pMid.lat, pMid.lon, p2.lat, p2.lon, 40);
        const pos = [];
        pts.forEach(p => { pos.push(p.x, p.y, p.z); });
        const lineGeo = new LineGeometry();
        lineGeo.setPositions(pos);
        const lineMat = new LineMaterial({ color: col, linewidth: lineWidth, resolution });
        const line = new Line2(lineGeo, lineMat);
        scene.add(line);
        routeLines.push(line);
        const connect13Long = document.getElementById("connect13Long");
        if (connect13Long && connect13Long.checked) {
          const v1 = latLonToVector3(p1.lat, p1.lon);
          const v3 = latLonToVector3(p2.lat, p2.lon);
          const wrapPts = slerpLongArc(v1, v3, 80);
          const wrapPos = [];
          wrapPts.forEach(p => { wrapPos.push(p.x, p.y, p.z); });
          const wrapGeo = new LineGeometry();
          wrapGeo.setPositions(wrapPos);
          const wrapMat = new LineMaterial({ color: col, linewidth: lineWidth, resolution, opacity: 0.85, transparent: true });
          const wrapLine = new Line2(wrapGeo, wrapMat);
          scene.add(wrapLine);
          routeWrapLines.push(wrapLine);
        }
        const points = [p1, pMid, p2];
        points.forEach((p, idx) => {
          const pos = latLonToVector3(p.lat, p.lon);
          const dot = new THREE.Mesh(
            new THREE.SphereGeometry(DOT_RADIUS, 16, 12),
            new THREE.MeshBasicMaterial({ color: col })
          );
          dot.position.copy(pos);
          scene.add(dot);
          routeDots.push(dot);
          const label = addLabelSprite(idx + 1, pos);
          scene.add(label);
          routeLabelSprites.push(label);
        });
      }
    }

    window.initGlobe = initGlobe;
    window.updateRoutes = updateRoutes;
    initGlobe();
    updateRoutes();
    const connect13LongEl = document.getElementById("connect13Long");
    if (connect13LongEl) connect13LongEl.addEventListener("change", updateRoutes);
  </script>
  <script>
    (function() {
      const DATA = {"locs": [{"name": "maputo, Mozambique", "lat": -25.9692, "lon": 32.5732}, {"name": "kandi, Benin", "lat": 11.1342, "lon": 2.9386}, {"name": "seoul, South Korea", "lat": 37.5665, "lon": 126.978}, {"name": "cairo, Egypt", "lat": 30.0444, "lon": 31.2357}, {"name": "lower hutt, New Zealand", "lat": -41.207, "lon": 174.9053}, {"name": "ankara, Turkey", "lat": 39.9334, "lon": 32.8597}, {"name": "tbilisi, Georgia", "lat": 41.7151, "lon": 44.8271}, {"name": "toad suck, AR", "lat": 35.089, "lon": -92.555}, {"name": "tijuana, Mexico", "lat": 32.5149, "lon": -117.0382}, {"name": "armavir, Armenia", "lat": 40.1545, "lon": 44.0382}, {"name": "doha, Qatar", "lat": 25.2854, "lon": 51.531}, {"name": "moscow, Russia", "lat": 55.7558, "lon": 37.6173}, {"name": "accra, Ghana", "lat": 5.6037, "lon": -0.187}, {"name": "kabul, Afghanistan", "lat": 34.5553, "lon": 69.2075}, {"name": "arles, France", "lat": 43.6766, "lon": 4.6278}, {"name": "kupang, Indonesia", "lat": -10.1833, "lon": 123.5833}, {"name": "lahore, Pakistan", "lat": 31.5204, "lon": 74.3587}, {"name": "lima, Peru", "lat": -12.0464, "lon": -77.0428}, {"name": "tashkent, Uzbekistan", "lat": 41.2995, "lon": 69.2401}, {"name": "tallinn, Estonia", "lat": 59.437, "lon": 24.7536}, {"name": "new orleans, LA", "lat": 29.9511, "lon": -90.0715}, {"name": "yellowstone, WY", "lat": 44.428, "lon": -110.5885}, {"name": "casablanca, Morocco", "lat": 33.5731, "lon": -7.5898}, {"name": "north york, Ontario, Canada", "lat": 43.7615, "lon": -79.4111}, {"name": "algiers, Algeria", "lat": 36.7538, "lon": 3.0588}, {"name": "tampa bay, FL", "lat": 27.9506, "lon": -82.4572}, {"name": "wichita, KS", "lat": 37.6872, "lon": -97.3301}, {"name": "tierra del fuego, Argentina", "lat": -54.8019, "lon": -68.303}, {"name": "dekalb, IL", "lat": 41.9295, "lon": -88.7504}, {"name": "montreal, Canada", "lat": 45.5017, "lon": -73.5673}, {"name": "cairns, Queensland, Australia", "lat": -16.9186, "lon": 145.7781}, {"name": "divo, C\u00f4te d'Ivoire", "lat": 5.8431, "lon": -5.361}, {"name": "copenhagen, Denmark", "lat": 55.6761, "lon": 12.5683}, {"name": "buffalo, NY", "lat": 42.8864, "lon": -78.8784}, {"name": "sucre, Bolivia", "lat": -19.0196, "lon": -65.262}, {"name": "quito, Ecuador", "lat": -0.2202, "lon": -78.5123}, {"name": "south pole, Antarctica", "lat": -90.0, "lon": 0.0}, {"name": "mal\u00e9, Maldives", "lat": 4.1755, "lon": 73.5093}, {"name": "iturup, Russia", "lat": 45.25, "lon": 147.8167}, {"name": "yellowknife, Canada", "lat": 62.454, "lon": -114.3718}, {"name": "thane, India", "lat": 19.2183, "lon": 72.9789}, {"name": "nazar\u00e9, Portugal", "lat": 39.6012, "lon": -9.0711}, {"name": "nome, AK", "lat": 64.5011, "lon": -165.4064}, {"name": "dimtu, Ethiopia", "lat": 6.9, "lon": 37.75}, {"name": "antananarivo, Madagascar", "lat": -18.8792, "lon": 47.5079}, {"name": "gaborone, Botswana", "lat": -24.6282, "lon": 25.9231}, {"name": "heard island, Australia", "lat": -53.0817, "lon": 73.5042}, {"name": "ile de la possession, France", "lat": -46.4167, "lon": 51.75}, {"name": "ascension island, United Kingdom", "lat": -7.9467, "lon": -14.3558}, {"name": "eyjafjallajokull, Iceland", "lat": 63.6333, "lon": -19.6167}], "roamy": [{"name": "casper, WY", "lat": 42.8666, "lon": -106.3131}, {"name": "arzamas, Russia", "lat": 55.3833, "lon": 43.8167}, {"name": "mubi, Nigeria", "lat": 10.2667, "lon": 13.2667}, {"name": "baku, Azerbaijan", "lat": 40.4093, "lon": 49.8671}, {"name": "moora, Australia", "lat": -30.6333, "lon": 116.0}, {"name": "surat, India", "lat": 21.1702, "lon": 72.8311}, {"name": "marquette, MI", "lat": 46.5436, "lon": -87.3954}, {"name": "beatty, NV", "lat": 36.9086, "lon": -116.7592}, {"name": "mosul, Iraq", "lat": 36.34, "lon": 43.13}, {"name": "visby, Sweden", "lat": 57.6348, "lon": 18.2948}, {"name": "istanbul, Turkey", "lat": 41.0082, "lon": 28.9784}, {"name": "genoa, Italy", "lat": 44.4056, "lon": 8.9463}, {"name": "mayotte, France", "lat": -12.8275, "lon": 45.1662}, {"name": "giresun, Turkey", "lat": 40.9128, "lon": 38.3895}, {"name": "l'ascension, Quebec", "lat": 48.6833, "lon": -71.6833}, {"name": "okato, New Zealand", "lat": -39.1833, "lon": 173.8833}, {"name": "nova russas, Brazil", "lat": -5.5667, "lon": -40.5667}, {"name": "\u010desk\u00e9 bud\u011bjovice, Czechia", "lat": 48.9745, "lon": 14.4747}, {"name": "christchurch, New Zealand", "lat": -43.5321, "lon": 172.6362}, {"name": "castelo branco, Portugal", "lat": 39.8222, "lon": -7.4908}, {"name": "sokode, Togo", "lat": 8.9833, "lon": 1.1333}, {"name": "curic\u00f3, Chile", "lat": -34.9828, "lon": -71.2394}, {"name": "monkey bay, Malawi", "lat": -14.0833, "lon": 34.9167}, {"name": "antalya, Turkey", "lat": 36.8969, "lon": 30.7133}, {"name": "ambanja, Madagascar", "lat": -13.6833, "lon": 48.45}, {"name": "saint-pierre, Saint Pierre and Miquelon", "lat": 46.7811, "lon": -56.1764}, {"name": "krasnodar, Russia", "lat": 45.035, "lon": 38.975}, {"name": "tucum\u00e1n, Argentina", "lat": -26.8083, "lon": -65.2172}, {"name": "derby, Western Australia", "lat": -17.3034, "lon": 123.6286}, {"name": "manaus, Brazil", "lat": -3.119, "lon": -60.0217}, {"name": "pune, India", "lat": 18.5204, "lon": 73.8567}, {"name": "hasik, Oman", "lat": 17.4833, "lon": 55.0333}, {"name": "velingrad, Bulgaria", "lat": 42.0167, "lon": 23.9833}, {"name": "marrakesh, Morocco", "lat": 31.6295, "lon": -7.9811}, {"name": "orlando, FL", "lat": 28.5383, "lon": -81.3792}, {"name": "charlotte, NC", "lat": 35.2271, "lon": -80.8431}, {"name": "edmonton, Canada", "lat": 53.5461, "lon": -113.4938}, {"name": "vladivostok, Russia", "lat": 43.1198, "lon": 131.8869}, {"name": "cochabamba, Bolivia", "lat": -17.3935, "lon": -66.157}, {"name": "tacurong, The Philippines", "lat": 6.6833, "lon": 124.6833}, {"name": "manistee, MI", "lat": 44.2445, "lon": -86.3242}]};
      window.ROUTE_DATA = DATA;
      const ROWS = 41;
      const COLORS = ["#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6","#bcf60c","#fabebe","#008080","#e6beff","#9a6324","#fffac8","#800000","#aaffc3","#808000","#ffd8b1","#000075","#808080","#e63946","#2a9d8f","#e9c46a","#1d3557","#457b9d","#a8dadc","#f4a261","#e76f51","#2ec4b6","#ff9f1c","#011627","#fdfffc","#41ead4","#ff006e","#8338ec","#3a86ff","#fb5607","#06d6a0","#118ab2","#ef476f","#ffd166","#073b4c"];
      const grid = document.getElementById("tripletGrid");
      grid.appendChild(document.createElement("div")).className = "header";
      grid.lastChild.textContent = "";
      grid.appendChild(document.createElement("div")).className = "header header-num";
      grid.lastChild.textContent = "#";
      grid.appendChild(document.createElement("div")).className = "header";
      grid.lastChild.innerHTML = '<span class="col-num">1</span>Location (start)';
      grid.appendChild(document.createElement("div")).className = "header";
      grid.lastChild.innerHTML = '<span class="col-num">2</span>Roamy (middle)';
      grid.appendChild(document.createElement("div")).className = "header";
      grid.lastChild.innerHTML = '<span class="col-num">3</span>Location (end)';
      grid.appendChild(document.createElement("div")).className = "header";
      grid.lastChild.textContent = "";

      for (let r = 0; r < ROWS; r++) {
        const swatch = document.createElement("div");
        swatch.className = "row-swatch";
        swatch.style.backgroundColor = COLORS[r % COLORS.length];
        swatch.title = "Row " + r + " — same color on globe";
        grid.appendChild(swatch);
        const rowNum = document.createElement("div");
        rowNum.className = "row-num";
        rowNum.textContent = r;
        grid.appendChild(rowNum);
        const s1 = document.createElement("select");
        s1.id = "loc1_" + r;
        s1.innerHTML = '<option value=""></option>' + DATA.locs.map((l,i) => '<option value="'+i+'">'+escapeHtml(l.name)+'</option>').join("");
        grid.appendChild(s1);
        const s2 = document.createElement("select");
        s2.id = "roamy_" + r;
        s2.innerHTML = '<option value=""></option>' + DATA.roamy.map((l,i) => '<option value="'+i+'">'+escapeHtml(l.name)+'</option>').join("");
        grid.appendChild(s2);
        const s3 = document.createElement("select");
        s3.id = "loc2_" + r;
        s3.innerHTML = '<option value=""></option>' + DATA.locs.map((l,i) => '<option value="'+i+'">'+escapeHtml(l.name)+'</option>').join("");
        grid.appendChild(s3);
        const clearBtn = document.createElement("button");
        clearBtn.className = "row-clear";
        clearBtn.type = "button";
        clearBtn.textContent = "×";
        clearBtn.title = "Clear row " + r;
        clearBtn.addEventListener("click", function() {
          s1.value = ""; s2.value = ""; s3.value = "";
          if (window.updateRoutes) window.updateRoutes();
        });
        grid.appendChild(clearBtn);
        [s1, s2, s3].forEach(s => s.addEventListener("change", () => window.updateRoutes && window.updateRoutes()));
      }
      function escapeHtml(s) {
        const d = document.createElement("div");
        d.textContent = s;
        return d.innerHTML;
      }
      function loadConfig(obj) {
        var rows = obj.rows || [];
        var nameToLocIndex = {};
        DATA.locs.forEach(function(l, i) { nameToLocIndex[l.name] = i; });
        var nameToRoamyIndex = {};
        DATA.roamy.forEach(function(l, i) { nameToRoamyIndex[l.name] = i; });
        for (var i = 0; i < 41; i++) {
          var s1 = document.getElementById("loc1_" + i), s2 = document.getElementById("roamy_" + i), s3 = document.getElementById("loc2_" + i);
          if (s1) s1.value = ""; if (s2) s2.value = ""; if (s3) s3.value = "";
        }
        for (var i = 0; i < rows.length; i++) {
          var row = rows[i];
          var r = (typeof row.row === "number" && row.row >= 0 && row.row < 41) ? row.row : i;
          var s1 = document.getElementById("loc1_" + r), s2 = document.getElementById("roamy_" + r), s3 = document.getElementById("loc2_" + r);
          if (!s1 || !s2 || !s3) continue;
          if (row.loc1 !== undefined && row.loc1 !== "" && nameToLocIndex[row.loc1] !== undefined) s1.value = String(nameToLocIndex[row.loc1]);
          if (row.roamy !== undefined && row.roamy !== "" && nameToRoamyIndex[row.roamy] !== undefined) s2.value = String(nameToRoamyIndex[row.roamy]);
          if (row.loc2 !== undefined && row.loc2 !== "" && nameToLocIndex[row.loc2] !== undefined) s3.value = String(nameToLocIndex[row.loc2]);
        }
        if (window.updateRoutes) window.updateRoutes();
      }
      fetch("route_config.json").then(function(r) { return r.ok ? r.json() : null; }).then(function(obj) {
        if (obj && obj.rows) loadConfig(obj);
      }).catch(function() {});
    })();
  </script>
</body>
</html>
